const axios = require("axios");
const cheerio = require("cheerio");
const FormData = require("form-data");


const textpro = async(url,text) => {  
  try {
let payload2; 
const res = await axios.get(url)
  const $ = cheerio.load(res.data);
 const token = $('#token').val();
const submit = $('#submit').val();
 const build_id = $('#build_server').val();
const build_server_id = $('build_server_id').val();
 const payload = {
   submit:submit,
   token:token,
   build_server:build_id,
   build_server_id:Number(build_server_id)
 }
  let form = new FormData()
      for (let i in payload) {
         form.append(i, payload[i])
      }
      
if (typeof text == "string") text = [text]
   for (let i of text) {
     form.append("text[]", i)
   }

  const headers2 = {
headers: {
"Accept": "*/*",
 "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
"Origin": "https://textpro.me",
"Referer": url,
"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36 Edg/115.0.1901.188",
"Cookie": res.headers.get("set-cookie").join("; ")
            }
  }
  
  await axios.post(url,form,headers2).then(async(res) => {
   let $ = cheerio.load(res.data);
   payload2 = ($('#form_value').first().text() || $('#form_value_input').first().text() || $('#form_value').first().val() || $('#form_value_input').first().val())
    return payload2;
  })
  let response;
  await axios.post("https://textpro.me/effect/create-image",JSON.parse(payload2),headers2).then(data => {
       response = {
    status:"ok",
    image:"https://textpro.me"+data.data.image
    }
    return response;
  })
  return response;
    } catch (error) {
     throw new Error(error)
  }
}


module.exports = {textpro}